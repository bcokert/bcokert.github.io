<!DOCTYPE HTML>
<html>
  <head>
    
      
        <title>Testing in React</title>
      
    

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Hugo 0.26" />
    
    
        
    

    

    <link rel="apple-touch-icon-precomposed"
        href='/favicon/apple-touch-icon-precomposed.png'>
    <link rel="icon" href='/favicon/favicon.png'>
    
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-TileImage"
        content='/favicon/mstile.png'>



    
      <meta name="author" content="Brandon Okert">
    
    
      <meta name="description" content="An Overview of Common Test Scenarios and Gotchas in ReactJs">
    

    <meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Testing in React"/>
<meta name="twitter:description" content="An Overview of Common Test Scenarios and Gotchas in ReactJs"/>
<meta name="twitter:site" content="@BrandonOkert"/>

    <meta property="og:title" content="Testing in React" />
<meta property="og:description" content="An Overview of Common Test Scenarios and Gotchas in ReactJs" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://brandonokert.com/articles/testinginreact/" />



<meta property="article:published_time" content="2015-08-04T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2015-08-04T00:00:00&#43;00:00"/>











    
<meta itemprop="name" content="Testing in React">
<meta itemprop="description" content="An Overview of Common Test Scenarios and Gotchas in ReactJs">


<meta itemprop="dateModified" content="2015-08-04T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2672">



<meta itemprop="keywords" content="javascript,react,testing,unittest,coverage,jasmine,karma,mocking,rewire," />

    

    

    <link rel="stylesheet" href="/css/google-font.css" />
    <link rel="stylesheet" href="/css/font-awesome.min.css" />
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/add-on.css" />
    <link rel="stylesheet" href="/css/monokai-sublime.css">

    
      <link rel="stylesheet" href="/css/custom.css" />
    

    
    
    
      
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-66027344-1', 'auto');
ga('send', 'pageview');
</script>

    
  </head>
  <body>

    
    <div id="wrapper">

    
    
<header id="header">
    
        <h2><a href="/">Brandon Okert</i></a></h2>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/">
                        
                            <i class="fa fa-file-text-o">&nbsp;</i>Articles
                    </a>
                </li>
            
                <li>
                    <a href="/tags/">
                        
                            <i class="fa fa-tags">&nbsp;</i>Tags
                    </a>
                </li>
            
                <li>
                    <a href="/about/">
                        
                            <i class="fa fa-question-circle-o">&nbsp;</i>About
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="q" value="site:http://brandonokert.com/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="q" value="site:http://brandonokert.com/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/">
                            <h3>
                                
                                    <i class="fa fa-file-text-o">&nbsp;</i>
                                
                                Articles
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/">
                            <h3>
                                
                                    <i class="fa fa-tags">&nbsp;</i>
                                
                                Tags
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about/">
                            <h3>
                                
                                    <i class="fa fa-question-circle-o">&nbsp;</i>
                                
                                About
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section>
            <ul class="links">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    <li>
                        <a href="http://brandonokert.com/articles/json-management-patterns-in-go/"><p>Json Management Patterns In Go</p></a>
                    </li>
                
                    <li>
                        <a href="http://brandonokert.com/articles/scaling-with-docker-part-2/"><p>Scaling with Docker Part 2</p></a>
                    </li>
                
                    <li>
                        <a href="http://brandonokert.com/articles/scaling-with-docker-part-1/"><p>Scaling with Docker Part 1</p></a>
                    </li>
                
                    <li>
                        <a href="http://brandonokert.com/articles/testinginreact/"><p>Testing in React</p></a>
                    </li>
                
                    <li>
                        <a href="http://brandonokert.com/articles/phpmessagescheduler/"><p>Building a Distributed Message Scheduler in PHP</p></a>
                    </li>
                
            </ul>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            


<li><a href="//twitter.com/share?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&text=Testing%20in%20React&via=BrandonOkert" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&title=Testing%20in%20React" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&title=Testing%20in%20React" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&title=Testing%20in%20React" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Brandon%20Okert&body=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
    <header>
    <div class="title">
        
            <h1><a href="http://brandonokert.com/articles/testinginreact/">Testing in React</a></h1>
            
        
        
            <p>An Overview of Common Test Scenarios and Gotchas in ReactJs</p>
        
    </div>
    <div class="meta">
        
            
        

        <time class="published"
            datetime='2015-08-04'>
            August 4, 2015</time>
        <span class="author">Brandon Okert</span>
        
        
    </div>
</header>


    <section id="social-share">
        <ul class="icons">
            


<li><a href="//twitter.com/share?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&text=Testing%20in%20React&via=BrandonOkert" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
</a></li>


<li><a href="//plus.google.com/share?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f" target="_blank" class="share-btn google-plus">
    <i class="fa fa-google-plus"></i>
    <p>Google+</p>
</a></li>


<li><a href="//www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
</a></li>


<li><a href="//reddit.com/submit?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&title=Testing%20in%20React" target="_blank" class="share-btn reddit">
    <i class="fa fa-reddit-alien"></i>
    <p>Reddit</p>
</a></li>


<li><a href="//www.linkedin.com/shareArticle?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&title=Testing%20in%20React" target="_blank" class="share-btn linkedin">
    <i class="fa fa-linkedin"></i>
    <p>LinkedIn</p>
</a></li>


<li><a href="//www.stumbleupon.com/submit?url=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f&title=Testing%20in%20React" target="_blank" class="share-btn stumbleupon">
    <i class="fa fa-stumbleupon"></i>
    <p>StumbleUpon</p>
</a></li>


<li><a href="mailto:?subject=Check out this post by Brandon%20Okert&body=http%3a%2f%2fbrandonokert.com%2farticles%2ftestinginreact%2f" target="_blank" class="share-btn email">
    <i class="fa fa-envelope"></i>
    <p>Email</p>
</a></li>

        </ul>
    </section>
    
    

    
        
        




    


        

        <a href="http://brandonokert.com/articles/testinginreact/" class="image featured">
            <img src="/img/TestingInReact//react-thumb.png" alt="" />
        </a>
    


    <div id="content">
        

<p>Having recently been tasked with bringing our JS test coverage in React to &gt;85%, I was surprised to find that there are scant resources for actually testing React components thoroughly. There are a few Test Utilities and getting started guides, but few examples to draw from for for in depth coverage. What do I do when I need to test a change in state resulting from a sequence of user actions? How can I verify a callback occurs at the correct time? How can I create effective mocks without drastically changing my architecture?</p>

<p>Through building up our own coverage, I&rsquo;ve collected several such scenarios and gotchas that one is likely to encounter.</p>

<!-- toc -->

<h1 id="scenarios">Scenarios</h1>

<p>The code examples are all written in the React Transpilers subset of ES6, and in Jasmine/Karma style. However, any toolset that allows manual control of test completion (for asynchronous testing) should be fine.</p>

<p>In addition, many scenarios make use of Test Utilities. These will be referred to by name in the &ldquo;Utility Patterns&rdquo; heading of each scenario.</p>

<h2 id="verify-component-renders-with-the-correct-dom">Verify Component Renders with the Correct DOM</h2>

<p>Utility Patterns: None</p>

<pre><code class="language-javascript">class MyComponent extends React.Component {
  render () {
    var children = this.props.children.map((child) =&gt; {
      return (&lt;li className='child'&gt;{child.sex === 'm' ? 'Son: ' : 'Daughter: '} Name: {child.name} ({child.age})&lt;/li&gt;);
    });

    return (
      &lt;div className='container -large'&gt;
        &lt;ul&gt;
          &lt;li&gt;Name: {this.props.name}&lt;/li&gt;
          {children}
        &lt;/ul&gt;
      &lt;/div&gt;
    );
  }
}
</code></pre>

<pre><code class="language-javascript">var TestUtils = require('react/lib/ReactTestUtils');
var MyComponent = require('src/components/my-component');

describe('MyComponent', () =&gt; {
  it('should render with the correct DOM', () =&gt; {
    var children = [
      {name: &quot;Billy&quot;, age: 4, sex: 'm'},
      {name: &quot;Sally&quot;, age: 6, sex: 'f'},
    ];
    var myComponent = TestUtils.renderIntoDocument(&lt;MyComponent children=/&gt;);
    var renderedDOM = () =&gt; React.findDOMNode(myComponent);

    expect(renderedDOM.tagName).toBe('div');
    expect(renderedDOM.classList).toEqual(['container', '-large']);
    //...

    var children = renderedDOM.querySelectorAll('li.child');
    expect(children.length).toBe(2);
    expect(children[0]).toEqual({name: &quot;Billy&quot;, age: 4, sex: 'm'});
    //...
  });
});
</code></pre>

<h2 id="verify-component-renders-its-child-components">Verify Component Renders its Child Components</h2>

<p>Utility Patterns: WithMocks</p>

<pre><code class="language-javascript">  it('should be rendered with an Avatar as a child', () =&gt; {
    profile = TestUtils.renderIntoDocument(&lt;Profile /&gt;);
    var child = ReactTestUtils.findRenderedComponentWithType(profile, Avatar);
    expect(ReactTestUtils.isCompositeComponentWithType(child, Avatar)).toBe(true);
  });
</code></pre>

<p>If you have mocked the child components, then you need to search for the mocked classes:</p>

<pre><code class="language-javascript">
  class MockAvatar extends React.Component {
    render () {...}
  }

  it('should be rendered with an Avatar as a child', () =&gt; {
    withMocks(Profile, {
      Avatar: MockAvatar
    }, () =&gt; {
      profile = TestUtils.renderIntoDocument(&lt;Profile /&gt;);
      var child = ReactTestUtils.findRenderedComponentWithType(profile, MockAvatar);
      expect(ReactTestUtils.isCompositeComponentWithType(child, Avatar)).toBe(true);
    });
  });
</code></pre>

<h2 id="verify-component-has-x-children">Verify Component has X Children</h2>

<p>Utility Patterns: None</p>

<pre><code class="language-javascript">  it('should be rendered with several child Profiles', () =&gt; {
    profileList = TestUtils.renderIntoDocument(&lt;ProfileList /&gt;);
    var children = ReactTestUtils.scryRenderedComponentsWithType(profileList, Profile);
    expect(children.length).toBe(5);
  });
</code></pre>

<h2 id="verify-component-passes-the-correct-props-to-its-child">Verify Component Passes the Correct Props to its Child</h2>

<p>Utility Patterns: None</p>

<p>Props are persistent for the current &lsquo;render&rsquo; of a component, and thus can be easily referred to at any point in a components lifetime.</p>

<pre><code class="language-javascript">  it('should pass the correct value into its child Avatar', () =&gt; {
    profile = TestUtils.renderIntoDocument(&lt;Profile /&gt;);
    var avatar = ReactTestUtils.findRenderedComponentWithType(profile, Avatar);
    expect(avatar.props.url).toBe(profile.state.mainAvatarUrl);
  });
</code></pre>

<h2 id="verify-components-callback-is-called-with-the-correct-params">Verify Components Callback is Called with the Correct Params</h2>

<p>Utility Patterns: WaitFor</p>

<pre><code class="language-javascript">  it('should call the onClose callback and pass in the accountLists id when close is clicked', (done) =&gt; {
    var wasCallbackCalledCorrectly = false;
    accountList = TestUtils.renderIntoDocument(&lt;AccountList id={42} onClose={(id) =&gt; {
      wasCallbackCalledCorrectly = id === 42;
    }} /&gt;);

    TestUtils.Simulate.click(React.findDOMNode(accountList.refs.closeButton));
    waitFor(() =&gt; wasCallbackCalledCorrectly, 'The onClose callback was not called when close was clicked', done);
  });
</code></pre>

<h2 id="verify-components-callback-is-not-called">Verify Components Callback is Not Called</h2>

<p>Utility Patterns: Then</p>

<pre><code class="language-javascript">  it('should not call the onClose callback when close is clicked but there is a warning', (done) =&gt; {
    accountList = TestUtils.renderIntoDocument(&lt;AccountList
      initialWarning='No profiles found. Please add at least one profile'
      onClose={() =&gt; {
        fail('The close callback was called while the account list contains a warning');
        done(); // ensure we don't waste time waiting for the test to time out
      }}
    /&gt;);

    TestUtils.Simulate.click(React.findDOMNode(accountList.refs.closeButton));
    then(() =&gt; done(), 100); // give the component 100ms to fail, then assume it hasn't called it
  });
</code></pre>

<h2 id="verify-components-callback-is-called-within-a-specific-time-window">Verify Components Callback is Called within a Specific Time-Window</h2>

<p>Utility Patterns: WaitFor, Then</p>

<pre><code class="language-javascript">  // Perhaps you want there to be a visual lag, so a process should take between x and y seconds #contrivedExample

  it('should call the onDataReceived callback between 1 and 2 seconds of clicking the refresh button', (done) =&gt; {
    var wasCallbackCalled = false;
    accountList = TestUtils.renderIntoDocument(&lt;AccountList onDataReceived={() =&gt; {
      wasCallbackCalled = true;
    }} /&gt;);

    TestUtils.Simulate.click(React.findDOMNode(accountList.refs.refreshButton));
    then(() =&gt; {
      expect(wasCallbackCalled).toBe(false);
      then(() =&gt; {
        waitFor(() =&gt; wasCallbackCalled, 'The onDataReceived callback was not called soon enough', done, 1025);
      });
    }, 975);
  });
</code></pre>

<h2 id="verify-components-state-is-correct-after-a-click">Verify Components State is Correct after a Click</h2>

<p>Utility Patterns: Then, WaitFor</p>

<pre><code class="language-javascript">  it('should store the selected Account when one is clicked', (done) =&gt; {
    var accounts = [1,2,3].map(() =&gt; createTestAccountData());
    var accountList = TestUtils.renderIntoDocument(&lt;AccountList accounts={accounts} /&gt;);

    // unlike re-rendering after a setState, renderIntoDocument will block until the component is rendered, so we can use it right away
    var accountToClick = TestUtils.scryRenderedComponentsWithType(accountList, Account)[1];
    TestUtils.Simulate.click(React.findDOMNode());

    then(() =&gt; {
      expect(accountList.state.selectedAccounts).toEqual([accounts[1]);
    });

    //OR

    waitFor(
      () =&gt; accountList.state.selectedAccounts.length === 1 &amp;&amp; accountList.state.selectedAccounts[0] === accounts[1],
      'The Account was not selected after clicking it',
      done
    );
  });
</code></pre>

<h2 id="verify-components-state-is-correct-after-typing">Verify Components State is Correct after Typing</h2>

<p>Utility Patterns: WaitFor</p>

<pre><code class="language-javascript">  it('should change the search query state after the user types in a name', (done) =&gt; {
    var accountList = TestUtils.renderIntoDocument(&lt;AccountList accounts={accounts} /&gt;);
    var searchBoxNode = React.findDOMNode(accountList.refs.searchBoxInput);

    searchBoxNode.value = 'Smitty Johnson';
    ReactTestUtils.Simulate.change(searchBoxNode);

    waitFor(
      () =&gt; accountlist.state.searchString === 'Smitty Johnson',
      'The search query was not updated after entering in a search string',
      done
    );
  });
</code></pre>

<h2 id="verify-components-state-is-correct-after-a-sequence-of-events">Verify Components State is Correct after a Sequence of Events</h2>

<p>Utility Patterns: Then</p>

<pre><code class="language-javascript">  it('should de-select any accounts when I select an account group', (done) =&gt; {
    accountSelector = TestUtils.renderIntoDocument(&lt;AccountSelector accounts={[...]} accountGroups={[...]} /&gt;);

    var accounts;

    accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
    TestUtils.Simulate.click(accounts[1]);
    then(() =&gt; {
      accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
      TestUtils.Simulate.click(accounts[2]);
    }).then(() =&gt; {
      accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
      TestUtils.Simulate.click(accounts[4]);
    }).then(() =&gt; {
      expect(accountSelector.state.selectedAccounts.length).toBe(3);

      var accountGroup = TestUtils.findRenderedComponentWithType(accountSelector, AccountGroup);
      TestUtils.Simulate.click(accountGroup);
    }).then(() =&gt; {
      expect(accountSelector.state.selectedAccounts.length).toBe(0);
      done();
    });
  });
</code></pre>

<h1 id="utility-patterns">Utility Patterns</h1>

<p>These patterns can make your life a lot easier, and make your tests cleaner to boot. I hesitate to call them libraries as they will likely have to be tuned to your specific scenario, and there are still edge cases that are not fully handled here. But by using them as building blocks, you should be able to extrapolate to solve various problems you might encounter.</p>

<h2 id="then">Then</h2>

<p>The Then pattern is good for sequencing of events in the event loop. Most things in React (changing this.state after a setState(), rendering after a setState) are queued immediately, so simply ensuring things run in order can make them easy to test.
We can use expect(&hellip;) within Then&rsquo;s without any surprises.</p>

<pre><code class="language-javascript">var then = function (callback, timeout) {
  setTimeout(callback, timeout &gt; 0 ? timeout : 0);
  return {then: then};
};

module.exports = then;
</code></pre>

<pre><code class="language-javascript">var then = require('lib/then');

it('should ...', (done) =&gt; {
  var component = ...;
  TestUtils.Simulate.click(React.findDOMNode(component));
  then(() =&gt; {
    TestUtils.Simulate.click(React.findDOMNode(component));
  }).then(() =&gt; {
    // we gave this one an extra 100 ms, so we need to nest further thens to ensure they run in order
    TestUtils.Simulate.click(React.findDOMNode(component));
    then(() =&gt; {
      expect(...);
      done();
    });
  }, 100);
});
</code></pre>

<h2 id="waitfor">WaitFor</h2>

<p>The WaitFor pattern is an extension of the then pattern, but instead of always doing something after a timeout, it waits for a condition to be true. This is useful primarily for asynchronous callbacks.</p>

<pre><code class="language-javascript">var waitsInProgress = [];

var waitFor = (test, message, done, timeLeft) =&gt; {
  timeLeft = timeLeft === undefined ? 100 : timeLeft;
  waitsInProgress.push(setTimeout(() =&gt; {
    if (timeLeft &lt;= 0) {
      fail(message);
      done();
    } else if (test()) {
      done();
    } else {
      waitFor(test, message, done, timeLeft - 10);
    }
  }, 10));
};

waitFor.clear = () =&gt; waitsInProgress.map(clearTimeout); //optionally call this in the beforeEach to ensure rogue tests are not still waiting

module.exports = waitFor;
</code></pre>

<p>We manually call fail within the waitFor, since asynchronous callbacks will not display the output of an expect upon failure.
In jasmine, if you want to wait for longer than 5 seconds (not recommended for unit tests) you need to set the max timeout in the last argument of your &lsquo;it&rsquo; function.</p>

<pre><code class="language-javascript">var waitFor = require('lib/waitFor');

it('should ...', (done) =&gt; {
  var component = ...;
  TestUtils.Simulate.click(React.findDOMNode(component));
  waitFor(
    () =&gt; component.state.isSelected,
    'The component was not selected after clicking it',
    done
  );
});

it('should wait for a long process', (done) =&gt; {
  var component = ...;
  TestUtils.Simulate.click(React.findDOMNode(component));
  waitFor(
    () =&gt; component.state.ajaxResult,
    'The component did not store the ajax response after clicking it and waiting 10 seconds',
    done,
    10000
  );
}, 10500);
</code></pre>

<h2 id="withmocksbeforeeach">WithMocksBeforeEach</h2>

<p>This is a useful pattern to use along with a rewired component and some mocks. Simply specify that for all of the following tests, the dependencies of the component are to be replaced by the given mocks. Great for mocking things like ajaxServices.
Kreds to <a href="https://twitter.com/theasta">Alex Boissi√©re</a> for the original implementation.</p>

<pre><code class="language-javascript">var withMocksBeforeEach = function withMocksBeforeEach(rewiredModule, varValues) {
  var rewiredReverts = [];

  beforeEach(function() {
    var key, value, revert;
    for (key in varValues) {
      if (varValues.hasOwnProperty(key)) {
        value = varValues[key];
        revert = rewiredModule.__set__(key, value);
        rewiredReverts.push(revert);
      }
    }
  });

  afterEach(function() {
    rewiredReverts.forEach(function(revert) {
      revert();
    });
  });

  return withMocksBeforeEach;
};

module.exports = withMocksBeforeEach;
</code></pre>

<pre><code class="language-javascript">var withMocksBeforeEach = require('lib/withMocksBeforeEach');
var rewire = require('rewire');

var LatestArticleButton = rewire('src/components/latest-article-button');

describe('The get latest article button', () =&gt; {
  var mockAjaxRequest = (url, callback) =&gt; callback({success: true, content: &quot;&quot;});
  var mockDatabase = {select: (table, command) =&gt; [], createTable: () =&gt; null};

  withMocksBeforeEach(LatestArticleButton, {
    ajaxRequest: mockAjaxRequest,
    factsDatabase: mockDatabase
  });

  it('should render a sorry message if an article is returned successfully but is empty', () =&gt; {
    var component = React.renderIntoDocument(&lt;LatestArticleButton /&gt;);
    TestUtils.Simulate.click(component.findDOMElement); // will eventually make an ajaxRequest
    waitFor(() =&gt; component.state.overlayMessage === 'That article is no longer available', 'The correct error was not displayed', done);
  });
});
</code></pre>

<h2 id="withmocks">WithMocks</h2>

<p>This is similar to the withMocksBeforeEach pattern, but can be applied to individual tests. Good for when some mocks are shared, and some are particular to only a single test.</p>

<pre><code class="language-javascript">var withMocks = function withMocks(dut, mockedDependencies, test) {
  var rewiredReverts = [];

  var key, value, revert;
  for (key in mockedDependencies) {
    if (mockedDependencies.hasOwnProperty(key)) {
      value = mockedDependencies[key];
      revert = dut.__set__(key, value);
      rewiredReverts.push(revert);
    }
  }

  var testThenCleanup = function() {
    test();
    rewiredReverts.forEach(function(revertToCall) {
      revertToCall();
    });
  };

  testThenCleanup();
};

module.exports = withMocks;
</code></pre>

<pre><code class="language-javascript">var withMocks = require('lib/withMocks');
var rewire = require('rewire');

var LatestArticleButton = rewire('src/components/latest-article-button');

describe('The get latest article button', () =&gt; {
  var mockAjaxRequest = (url, callback) =&gt; callback({success: true, content: &quot;&quot;});
  var mockDatabase = {select: (table, command) =&gt; [], createTable: () =&gt; null};

  it('should render a sorry message if an article is returned successfully but is empty', () =&gt; {
    withMocks(LatestArticleButton, {
      ajaxRequest: mockAjaxRequest,
      factsDatabase: mockDatabase
    }, () =&gt; {
      var component = React.renderIntoDocument(&lt;LatestArticleButton /&gt;);
      TestUtils.Simulate.click(component.findDOMElement); // will eventually make an ajaxRequest
      waitFor(() =&gt; component.state.overlayMessage === 'That article is no longer available', 'The correct error was not displayed', done);
    });
  });
});
</code></pre>

<h1 id="gotchas">Gotchas</h1>

<h2 id="you-cannot-check-state-render-or-simulate-right-after-simulating-an-event">You Cannot Check State/Render or Simulate Right After Simulating an Event</h2>

<p>This will seem obvious if you&rsquo;ve already gone through some of the scenarios. Consider the following test:</p>

<pre><code class="language-javascript">it('should add the clicked account to the list of selected accounts', () =&gt; {
  accountSelector = TestUtils.renderIntoDocument(&lt;AccountSelector accounts={[...]} accountGroups={[...]} /&gt;);

  var accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
  TestUtils.Simulate.click(accounts[1]);
  expect(accountSelector.state.selectedAccounts.length).toBe(1);
});
</code></pre>

<p>This will fail, saying that accountSelector.state.selectedAccounts.length is 0, which it is.
When we clicked the account, we triggered a setState, which will in turn change the actual state, as well as re-render. However, both of these are not done synchronously - they are added to the next slot in the event loop.</p>

<p>This applies to sequences of simulations as well:</p>

<pre><code class="language-javascript">it('should de-select any accounts when I select an account group', () =&gt; {
  accountSelector = TestUtils.renderIntoDocument(&lt;AccountSelector accounts={[...]} accountGroups={[...]} /&gt;);

  var accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
  var accountGroup = TestUtils.findRenderedComponentWithType(accountSelector, AccountGroup);

  TestUtils.Simulate.click(accounts[1]);
  TestUtils.Simulate.click(accounts[2]);
  TestUtils.Simulate.click(accounts[4]);
  expect(accountSelector.state.selectedAccounts.length).toBe(3);
  TestUtils.Simulate.click(accountGroup);
  expect(accountSelector.state.selectedAccounts.length).toBe(0);
});
</code></pre>

<p>The operation of these simulations all depend on the state and DOM generated by the previous actions, and thus the result will not be what you expect.</p>

<p>The solution to both of these problems is to use the Then pattern, or the WaitFor pattern, along with manual termination of tests:</p>

<pre><code class="language-javascript">  it('should add the clicked account to the list of selected accounts', (done) =&gt; {
    accountSelector = TestUtils.renderIntoDocument(&lt;AccountSelector accounts={[...]} accountGroups={[...]} /&gt;);

    var accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
    TestUtils.Simulate.click(accounts[1]);
    then(() =&gt; {
      expect(accountSelector.state.selectedAccounts.length).toBe(1);
      done();
    });

    //OR

    waitFor(() =&gt; accountSelector.state.selectedAccounts.length === 1, 'The selectedAccounts list was not updated after clicking an account', done);
  });
</code></pre>

<p>See the next Gotcha for an example of proper sequencing for Simulations.</p>

<h2 id="you-cannot-simulate-events-in-series-without-re-finding-dom-components">You Cannot Simulate Events in Series Without Re-Finding DOM Components</h2>

<p>Consider the following test, where we already know we have to sequence our simulations:</p>

<pre><code class="language-javascript">  it('should de-select any accounts when I select an account group', (done) =&gt; {
    accountSelector = TestUtils.renderIntoDocument(&lt;AccountSelector accounts={[...]} accountGroups={[...]} /&gt;);

    var accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
    var accountGroup = TestUtils.findRenderedComponentWithType(accountSelector, AccountGroup);

    TestUtils.Simulate.click(accounts[1]);
    then(() =&gt; {
      TestUtils.Simulate.click(accounts[2]);
    }).then(() =&gt; {
      TestUtils.Simulate.click(accounts[4]);
    }).then(() =&gt; {
      expect(accountSelector.state.selectedAccounts.length).toBe(3);
      TestUtils.Simulate.click(accountGroup);
    }).then(() =&gt; {
      expect(accountSelector.state.selectedAccounts.length).toBe(0);
      done();
    });
  });
</code></pre>

<p>If you run this, you&rsquo;ll right away notice what&rsquo;s wrong: it&rsquo;ll fail with a cryptic error:</p>

<pre><code class="language-bash">Error: Invariant Violation: Component (with keys: getDOMNode,props,context,state,refs,_reactInternalInstance) contains `render` method but is not mounted in the DOM
</code></pre>

<p>This is occurring because you are Simulating an event on a DOM element that is no longer rendered. Via closure, the reference in accounts[2] is still a valid pointer, but it is no longer in the DOM, because clicking on the first button has changed the state, which in turned casues a re-render, replacing the old DOM nodes. After the re-render, we need to re-grab the DOM node that we want to click.</p>

<pre><code class="language-javascript">  it('should de-select any accounts when I select an account group', (done) =&gt; {
    accountSelector = TestUtils.renderIntoDocument(&lt;AccountSelector accounts={[...]} accountGroups={[...]} /&gt;);

    var accounts;

    accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
    TestUtils.Simulate.click(accounts[1]);
    then(() =&gt; {
      accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
      TestUtils.Simulate.click(accounts[2]);
    }).then(() =&gt; {
      accounts = TestUtils.scryRenderedComponentsWithType(accountSelector, Account);
      TestUtils.Simulate.click(accounts[4]);
    }).then(() =&gt; {
      expect(accountSelector.state.selectedAccounts.length).toBe(3);

      var accountGroup = TestUtils.findRenderedComponentWithType(accountSelector, AccountGroup);
      TestUtils.Simulate.click(accountGroup);
    }).then(() =&gt; {
      expect(accountSelector.state.selectedAccounts.length).toBe(0);
      done();
    });
  });
</code></pre>

<h2 id="testutils-mockcomponent-wont-create-basic-mocks">TestUtils.mockComponent wont create basic mocks</h2>

<p><a href="https://facebook.github.io/react/docs/test-utils.html#mockcomponent">According to the React TestUtils Docs</a>, you can use TestUtils.mockComponent() to create a quick mock that simply renders an empty div. However, what is not documented is that this feature is only available if you are using Jest.</p>

<p>The intended use case is:</p>

<pre><code class="language-javascript">TestUtils.mockComponent(jest.genMockFunction());
</code></pre>

<p>If you do need a basic dummy component, you can simply create a shared inline mock component:</p>

<pre><code class="language-javascript">class MockedSubComponent extends React.Component {
  render () {
    return &lt;div&gt;&lt;/div&gt;;
  }
}
</code></pre>

<h2 id="expectations-won-t-print-inside-asynchronous-tests">Expectations won&rsquo;t print inside asynchronous tests</h2>

<p>For a regular test, you utilize <em>expect</em> to ensure your conditions are met, and depend on its output to tell you where and why something failed. However, within an asynchronous test, this output will not come out, and instead your test will block for some time (default 5 seconds) and then fail with a generic Async timeout failure.</p>

<p>The solution to this is to simply manually call fail.</p>

<pre><code class="language-javascript">  it('should update the account name if its empty and we refresh it', (done) =&gt; {
    var accountDisplay = TestUtils.renderIntoDocument(AccountDisplay);
    TestUtils.Simulate.click(React.findDOMNode(accountDisplay.refs.refreshButton));

    // We should use the WaitFor pattern here, but I'll show it without it to illustrate the manual failure
    setTimeout(() =&gt; {
      // if we call expect here and it fails, we won't get the right error message, but instead an async timeout message
      if (accountDisplay.state.accountName !== 'Test Account 1234') {
        fail('The account name was not updated after refreshing the display and waiting 2 seconds. Found: ' + accountDisplay.state.accountName);
      }
      done(); // the done call ensures our test does not timeout, nor waste any extra time. It is called even if fail was called
    }, 2000);
  });
</code></pre>

<p>This is also how the WaitFor pattern works.</p>

<h2 id="mocked-dependencies-must-be-searched-for-my-their-mock-class">Mocked dependencies must be searched for my their mock class</h2>

<p>Mocking with rewire in javascript does not provide full polymorphism - if you override a mock class my name, any reference to the original will now be a mock component, but the <em>type</em> of the new components will be MockComponent.</p>

<p>This means you have to search for sub-components by their mock classes name, rather than their original name:</p>

<pre><code class="language-javascript">
  class MockAvatar extends React.Component {
    render () {...}
  }

  it('should be rendered with an Avatar as a child', () =&gt; {
    withMocks(Profile, {
      Avatar: MockAvatar
    }, () =&gt; {
      profile = TestUtils.renderIntoDocument(&lt;Profile /&gt;);

      // Wrong
      var child = ReactTestUtils.findRenderedComponentWithType(profile, Avatar);
      expect(ReactTestUtils.isCompositeComponentWithType(child, Avatar)).toBe(true);

      // Right
      var child = ReactTestUtils.findRenderedComponentWithType(profile, MockAvatar);
      expect(ReactTestUtils.isCompositeComponentWithType(child, MockAvatar)).toBe(true);
    });
  });
</code></pre>

<p>This does not change how your component has to use the mocked component - it&rsquo;s just a technicality you have to watch out for from outside of the component.</p>

    </div>

    <footer>
        <ul class="stats">
    
        

        
        
            <li>
                
                
                    

                    

                    
                        <i class="Page(&#34;Testing in React&#34;)">&nbsp; Tags</i>
                    
                
            </li>
        
    

    
    
        <li><a href='/tags/javascript'>javascript</a></li>
    
        <li><a href='/tags/react'>react</a></li>
    
        <li><a href='/tags/testing'>testing</a></li>
    
        <li><a href='/tags/unittest'>unittest</a></li>
    
        <li><a href='/tags/coverage'>coverage</a></li>
    
        <li><a href='/tags/jasmine'>jasmine</a></li>
    
        <li><a href='/tags/karma'>karma</a></li>
    
        <li><a href='/tags/mocking'>mocking</a></li>
    
        <li><a href='/tags/rewire'>rewire</a></li>
    
</ul>

    </footer>
</article>
<ul class="actions pagination">
    
        <li><a href="http://brandonokert.com/articles/phpmessagescheduler/"
                class="button big previous">Building a Distributed Message Scheduler in PHP</a></li>
    

    
        <li><a href="http://brandonokert.com/articles/scaling-with-docker-part-1/"
                class="button big next">Scaling with Docker Part 1</a></li>
    
</ul>



    
        <article class="post">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "brandonokert" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </article>
    


    </div>
    
<section id="sidebar">

    
        <section id="intro">
            
            
                
                    <img src="http://www.gravatar.com/avatar/1796d3ceead403d9616a2093bc42ec18?s=110" width="" alt="My face" />
                
            
            
                <header>
                    <h2>Brandon Okert</h2>
                    <p>Husband, Full Stack Web Developer, Gopher, Runner, Coffee Lover, Book Reader, Food Maker.</p>
                </header>
            
            <ul class="icons">
                
                
                    
<li><a href="//github.com/bcokert" target="_blank" title="GitHub" class="fa fa-github"></a></li>



































<li><a href="//linkedin.com/in/brandon-okert-850aa632" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>















<li><a href="//twitter.com/BrandonOkert" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>
        </section>

    
      
        <section id="recent-posts">
            <ul class="posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                
                    
                

                
                    
                

                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://brandonokert.com/articles/json-management-patterns-in-go/">Json Management Patterns In Go</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-04-18'>
                                    April 18, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://brandonokert.com/articles/scaling-with-docker-part-2/">Scaling with Docker Part 2</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-03-07'>
                                    March 7, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://brandonokert.com/articles/scaling-with-docker-part-1/">Scaling with Docker Part 1</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2016-02-16'>
                                    February 16, 2016</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://brandonokert.com/articles/testinginreact/">Testing in React</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2015-08-04'>
                                    August 4, 2015</time>
                            </header>
                        </article>
                    </li>
                
                    <li>
                        <article>
                            <header>
                                <h3><a href="http://brandonokert.com/articles/phpmessagescheduler/">Building a Distributed Message Scheduler in PHP</a></h3>
                                
                                    
                                
                                <time class="published" datetime=
                                    '2014-07-21'>
                                    July 21, 2014</time>
                            </header>
                        </article>
                    </li>
                

                
                    <li>
                        <ul class="actions">
                            <li><a href=
                            
                                /
                            
                            class="button">View more posts</a></li>
                        </ul>
                    </li>
                
            </ul>
        </section>
      

    

    
        

    
        <section id="footer">
            <ul class="icons">
                
                
                    
<li><a href="//github.com/bcokert" target="_blank" title="GitHub" class="fa fa-github"></a></li>



































<li><a href="//linkedin.com/in/brandon-okert-850aa632" target="_blank" title="LinkedIn" class="fa fa-linkedin"></a></li>















<li><a href="//twitter.com/BrandonOkert" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




                
            </ul>

            <p class="copyright">&copy; BrandonOkert.com. Powered by <a href="//gohugo.io" target="_blank">Hugo</a></p>
        </section>

</section>

            </div>
        <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
        

        <script src="/js/jquery.min.js"></script>
        <script src="/js/skel.min.js"></script>
        <script src="/js/util.js"></script>
        <script src="/js/main.js"></script>
        <script src="/js/backToTop.js"></script>
        <script src="/js/highlight.pack.js"></script>

        
            <script src="/js/sequenced-image.js"></script>
        

            
            <script>hljs.initHighlightingOnLoad();</script>
            
    </body>
</html>

